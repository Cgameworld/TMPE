# Logging in TM:PE

This guide explains:

* Why we use `TMPE.log`
* How to enable predefined debug logging
* Log methods and when to use them

> TM:PE logging is not as simple as one would expect, [because reasons](https://github.com/krzychu124/Cities-Skylines-Traffic-Manager-President-Edition/issues/349#issuecomment-512650775).

## Why `TMPE.log`?

The game log (either `output_log.txt` on Windows, or `Player.log` on Mac/Linux) is generally huge and difficult to browse, so we use a dedicated `TMPE.log` to make life a bit easier for ourselves.

The log file location depends on operating system:

* Windows: Same folder as your `output_log.txt`
* Mac: See [Issue #379](https://github.com/krzychu124/Cities-Skylines-Traffic-Manager-President-Edition/issues/379)
* Linux: Probably in `~/.config/unity3d/Colossal Order/Cities: Skylines/TMPE.log`

More importantly, TM:PE has lots of ready made logging that can be turned on or off as required...

## Log switches

> TODO:
> * Explain `DebugSwitch` and how to flick the switch

## Logging methods

We use our own logging class that provides some features tailored to the specific needs of TM:PE.

The `static` logging class can be found in [`CSUtil.Commons/Log.cs`.](https://github.com/krzychu124/Cities-Skylines-Traffic-Manager-President-Edition/blob/master/TLM/CSUtil.Commons/Log.cs)

### Performance considerations

Large swathes of TM:PE code is called every frame. Logging needs to be performance tuned.

> Note: We could probably, at some point, make the log writer run in its own thread, but haven't got round to that yet.

#### Log.Info, Log.Warning, Log.Error, Log.\_Debug, Log.\_Trace:

* String is formatted at call site
* âš  Expensive if multiple `$"string {interpolations}"` are used
* âœ” Cheap if wrapped in an `if (booleanValue) { ... }`
* âœ” Cheap if there is a const string or a very simple format call with a few args
* `Log._Debug()` and `Log._Trace()` calls are removed by compiler in all `RELEASE` builds

#### Log.InfoFormat, Log.\_DebugFormat, etc.:

* Message formatted at callee site, during logging
* âš  Expensive if not wrapped in a `if (boolValue) { ... }` condition
* âœ” Good for very long format strings with multiple complex arguments
* âœ” As they use format string literal, it can be split multiple lines without performance penalty
* âœ” Prevents multiple calls to `string.Format()` unlike multiline `$"string {interpolations}"`
* ðŸ’² The cost incurred: building args array (with pointers)
* `Log._DebugFormat()` calls are removed by compiler in all `RELEASE` builds

#### Log.WarningIf, Log.\_DebugIf, etc:

* If the condition is `true`, invoke the lambda and log the string it returns
* âš  Cannot capture `out` and `ref` values
* âœ” Lambda building is just as cheap as format args building
* âœ” Actual string is formatted ONLY if the condition holds true
* ðŸ’² The cost incurred: Each captured variable is copied into lambda function
* `Log.DebugIf()` calls are removed by compiler in all `RELEASE` builds

#### Log.NotImpl:

* Use to log an error if an unimplemented method is called
* `Log.NotImpl()` calls are removed by compiler in all `RELEASE` builds

### All builds

These methods are available in all builds, including `RELEASE`.

> :warning: Use sparingly and avoid in-game usage as they will [completely tank frame rate](https://github.com/krzychu124/Cities-Skylines-Traffic-Manager-President-Edition/issues/411).

#### `Log.Info(str)`

Writes a simple string to the log file.

```csharp
Log.Info("Hello world!");
```

Avoid concatenating multiple `$"string {interpolations}"` as it's very expensive; use `Log.InfoFormat()` instead.

#### `Log.InfoFormat(format, args)`

```csharp
Log.InfoFormat("Some {0} {1} {3}", "string", "with", "args");
```

#### `Log.Warning(str)`

Like `Log.Info()` but at warning level. Also outputs a stack trace.

#### `Log.WarningFormat(format, args)`

Like `Log.InfoFormat()` but at warning level. Also outputs a stack trace.

#### `Log.WarningIf(switch, func)`

Similar to `Log.Warning()` but the string is generated by a lambda function (`func` param).

The function is only called, while logging, if `switch` evaluates to `true`.

```csharp
Log.WarningIf(DebugSwitch.LaneConnections.Get(), () => $"string {interpolation}");
```

#### `Log.Error(str)`

Like `Log.Info()` but at error level. Also outputs a stack trace.

#### `Log.ErrorFormat(format, args)`

Like `Log.InfoFormat()` but at error level. Also outputs a stack trace.

#### `Log.ErrorIf(switch, func)`

Like `Log.WarningIf()` but at error level. Also outputs a stack trace.

### Debug builds only

Methods prefixed with `_`, and also the `NotImpl()` method, are only available in `DEBUG` build configurations.

#### `Log._Debug(str)`

Like `Log.Info()` but at `Debug` level.

#### `Log._DebugFormat(format, args)`

Like `Log.InfoFormat()` but at `Debug` level.

#### `Log._DebugIf(switch, func)`

Like `Log.WarningIf()` but at `Debug` level (no stack trace).

#### `Log._DebugOnlyWarning(str)`

Like `Log.Warning()`.

#### `Log._DebugOnlyWarningIf(switch, func)`

Like `Log.WarningIf()`.

#### `Log._DebugOnlyError(str)`

Like `Log.Error()`.

#### `Log._Trace(str)`

Like `Log.Info()` but at `Trace` level.

Requires both the `DEBUG` and `TRACE` defines.

#### `Log.NotImpl(str)`

Like `Log.DebugOnlyError()` but prefixes the string with `Not implemented:`.
